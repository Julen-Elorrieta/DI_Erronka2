<div class="meetings-container">
  <div class="page-header">
    <h1>{{ 'MEETING.CENTERS' | translate }}</h1>
    @if (canCreateMeeting()) {
      <button
        mat-raised-button
        color="primary"
        class="create-button"
        (click)="openCreateMeetingDialog()"
      >
        <mat-icon>add</mat-icon>
        {{ 'MEETING.CREATE' | translate }}
      </button>
    }
  </div>

  <mat-tab-group [selectedIndex]="activeTab$ | async" (selectedIndexChange)="onTabChange($event)">
    <!-- ============================================ -->
    <!-- TAB: CENTROS -->
    <!-- ============================================ -->
    <mat-tab>
      <ng-template mat-tab-label>
        <mat-icon class="tab-icon">business</mat-icon>
        {{ 'MEETING.CENTERS' | translate }}
      </ng-template>

      @if (processedData$ | async; as data) {
        <mat-card class="filters-card">
          <mat-card-content>
            <div class="filters-row">
              <mat-form-field appearance="outline" class="filter-field">
                <mat-label>{{ 'FILTER.NAME' | translate }}</mat-label>
                <input
                  matInput
                  [value]="(filters$ | async)?.searchText || ''"
                  (input)="onSearchChange($any($event.target).value)"
                  placeholder="{{ 'FILTER.SEARCH_NAME' | translate }}"
                />
                <button mat-icon-button matSuffix tabindex="-1" disabled>
                  <mat-icon>search</mat-icon>
                </button>
              </mat-form-field>

              <mat-form-field appearance="outline" class="filter-field">
                <mat-label>{{ 'FILTER.TITULARIDAD' | translate }}</mat-label>
                <mat-select
                  [value]="(filters$ | async)?.titularidad || ''"
                  (selectionChange)="onTitularidadChange($event.value)"
                >
                  <mat-option value="">{{ 'COMMON.ALL' | translate }}</mat-option>
                  @for (t of data.filterOptions.titularidades; track t) {
                    <mat-option [value]="t">{{ t }}</mat-option>
                  }
                </mat-select>
              </mat-form-field>

              <mat-form-field appearance="outline" class="filter-field">
                <mat-label>{{ 'FILTER.TERRITORIO' | translate }}</mat-label>
                <mat-select
                  [value]="(filters$ | async)?.territorio || ''"
                  (selectionChange)="onTerritorioChange($event.value)"
                >
                  <mat-option value="">{{ 'COMMON.ALL' | translate }}</mat-option>
                  @for (t of data.filterOptions.territorios; track t) {
                    <mat-option [value]="t">{{ t }}</mat-option>
                  }
                </mat-select>
              </mat-form-field>

              <mat-form-field appearance="outline" class="filter-field">
                <mat-label>{{ 'FILTER.MUNICIPIO' | translate }}</mat-label>
                <mat-select
                  [value]="(filters$ | async)?.municipio || ''"
                  (selectionChange)="onMunicipioChange($event.value)"
                >
                  <mat-option value="">{{ 'COMMON.ALL' | translate }}</mat-option>
                  @for (m of data.filterOptions.municipios; track m) {
                    <mat-option [value]="m">{{ m }}</mat-option>
                  }
                </mat-select>
              </mat-form-field>

              @if (data.hasActiveFilters) {
                <button mat-button (click)="clearFilters()">
                  <mat-icon>clear</mat-icon>
                  {{ 'COMMON.CLEAR' | translate }}
                </button>
              }
            </div>
          </mat-card-content>
        </mat-card>

        <div class="results-info">
          <span class="results-count">
            <mat-icon>business</mat-icon>
            {{ data.total }} {{ 'MEETING.CENTERS_COUNT' | translate }}
          </span>
        </div>

        <div class="main-content">
          <mat-card class="table-card">
            @if (loading$ | async) {
              <div class="loading-container">
                <mat-spinner diameter="50"></mat-spinner>
              </div>
            } @else {
              <table mat-table [dataSource]="data.paginated" class="centers-table">
                <ng-container matColumnDef="name">
                  <th mat-header-cell *matHeaderCellDef>{{ 'CENTER.NAME' | translate }}</th>
                  <td mat-cell *matCellDef="let center">
                    <div class="center-name">
                      <strong>{{ center.NOM }}</strong>
                      <span class="center-code">{{ center.CCEN }}</span>
                    </div>
                  </td>
                </ng-container>

                <ng-container matColumnDef="DTITUC">
                  <th mat-header-cell *matHeaderCellDef>{{ 'FILTER.TITULARIDAD' | translate }}</th>
                  <td mat-cell *matCellDef="let center">
                    <span
                      class="titularidad-badge"
                      [ngClass]="'tit-' + center.DTITUC.toLowerCase()"
                    >
                      {{ center.DTITUC }}
                    </span>
                  </td>
                </ng-container>

                <ng-container matColumnDef="DTERRC">
                  <th mat-header-cell *matHeaderCellDef>{{ 'FILTER.TERRITORIO' | translate }}</th>
                  <td mat-cell *matCellDef="let center">{{ center.DTERRC }}</td>
                </ng-container>

                <ng-container matColumnDef="DMUNIC">
                  <th mat-header-cell *matHeaderCellDef>{{ 'FILTER.MUNICIPIO' | translate }}</th>
                  <td mat-cell *matCellDef="let center">{{ center.DMUNIC }}</td>
                </ng-container>

                <ng-container matColumnDef="actions">
                  <th mat-header-cell *matHeaderCellDef>{{ 'COMMON.ACTIONS' | translate }}</th>
                  <td mat-cell *matCellDef="let center">
                    <div class="actions-cell">
                      <button
                        mat-icon-button
                        color="primary"
                        (click)="openCenterDetail(center)"
                        [matTooltip]="'CENTER.DETAILS' | translate"
                      >
                        <mat-icon>info</mat-icon>
                      </button>
                      @if (center.LATITUD && center.LONGITUD) {
                        <button
                          mat-icon-button
                          color="accent"
                          (click)="focusOnCenter(center)"
                          [matTooltip]="'CENTER.VIEW_MAP' | translate"
                        >
                          <mat-icon>place</mat-icon>
                        </button>
                      }
                      @if (canCreateMeeting()) {
                        <button
                          mat-icon-button
                          color="primary"
                          (click)="openCreateMeetingDialog(center)"
                          [matTooltip]="'MEETING.CREATE_IN_CENTER' | translate"
                        >
                          <mat-icon>event</mat-icon>
                        </button>
                      }
                    </div>
                  </td>
                </ng-container>

                <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
                <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
              </table>

              @if (data.total === 0) {
                <div class="no-data">
                  <mat-icon>search_off</mat-icon>
                  <p>{{ 'COMMON.NO_RESULTS' | translate }}</p>
                </div>
              }

              @if (pagination$ | async; as pag) {
                <mat-paginator
                  [length]="data.total"
                  [pageSize]="pag.pageSize"
                  [pageIndex]="pag.pageIndex"
                  [pageSizeOptions]="pageSizeOptions"
                  (page)="onPageChange($event)"
                  showFirstLastButtons
                >
                </mat-paginator>
              }
            }
          </mat-card>

          <mat-card class="map-card">
            <mat-card-header>
              <mat-card-title>
                <mat-icon>map</mat-icon>
                {{ 'CENTER.MAP' | translate }}
              </mat-card-title>
            </mat-card-header>
            <mat-card-content>
              <div #mapContainer class="map-container" style="width: 100%; height: 500px"></div>
            </mat-card-content>
          </mat-card>
        </div>
      }
    </mat-tab>

    <!-- ============================================ -->
    <!-- TAB: MIS REUNIONES -->
    <!-- ============================================ -->
    <mat-tab>
      <ng-template mat-tab-label>
        <mat-icon class="tab-icon">event</mat-icon>
        {{ 'MEETING.MY_MEETINGS' | translate }}
      </ng-template>

      <mat-card class="meetings-list-card">
        <mat-card-content>
          @if (loadingMeetings$ | async) {
            <div class="loading-container">
              <mat-spinner diameter="50"></mat-spinner>
              <p style="margin-top: 16px; color: rgba(0, 0, 0, 0.6)">Bilerak kargatzen...</p>
            </div>
          } @else {
            @if (meetings$ | async; as meetings) {
              @if (meetings.length === 0) {
                <div class="no-data">
                  <mat-icon>event_busy</mat-icon>
                  <p>{{ 'MEETING.NO_MEETINGS' | translate }}</p>
                  <small style="margin-top: 8px; color: rgba(0, 0, 0, 0.5)"
                    >Ez dituzu bilerarik programatuta</small
                  >
                </div>
              } @else {
                <div class="meetings-list">
                  @for (meeting of meetings; track trackByMeeting($index, meeting)) {
                    <div class="meeting-item">
                      <div class="meeting-date">
                        <span class="day">{{ meeting.date | date: 'dd' }}</span>
                        <span class="month">{{ meeting.date | date: 'MMM' }}</span>
                        <span class="year">{{ meeting.date | date: 'yyyy' }}</span>
                      </div>
                      <div class="meeting-info">
                        <h3>{{ meeting.title }}</h3>
                        @if (meeting.subject) {
                          <p class="meeting-subject">{{ meeting.subject }}</p>
                        }
                        <div class="meeting-details">
                          <span> <mat-icon>schedule</mat-icon> {{ meeting.hour }} </span>
                          <span> <mat-icon>room</mat-icon> {{ meeting.classroom }} </span>
                          <span> <mat-icon>place</mat-icon> {{ meeting.centerName }} </span>
                        </div>
                        <div class="meeting-meta">
                          @if (meeting.teacherId) {
                            <span class="meta-badge">
                              <mat-icon>person</mat-icon> Irakasle ID: {{ meeting.teacherId }}
                            </span>
                          }
                          @if (meeting.studentId) {
                            <span class="meta-badge">
                              <mat-icon>school</mat-icon> Ikasle ID: {{ meeting.studentId }}
                            </span>
                          }
                        </div>
                      </div>
                      <div class="meeting-actions">
                        <div class="meeting-status">
                          <span class="status-badge" [ngClass]="getStatusClass(meeting.status)">
                            {{ getStatusLabel(meeting.status) }}
                          </span>
                        </div>

                        <!-- âœ… Egoeraren araberako ekintza botoiak (ENUM: pendiente, aceptada, denegada, conflicto) -->
                        @if (canChangeStatus(meeting)) {
                          <button
                            mat-icon-button
                            [matMenuTriggerFor]="statusMenu"
                            matTooltip="Egoera aldatu"
                            class="status-menu-button"
                          >
                            <mat-icon>more_vert</mat-icon>
                          </button>

                          <mat-menu #statusMenu="matMenu">
                            @for (
                              action of getAvailableStatusActions(meeting);
                              track action.status
                            ) {
                              <button
                                mat-menu-item
                                (click)="updateMeetingStatus(meeting, action.status)"
                              >
                                <mat-icon [color]="action.color">{{ action.icon }}</mat-icon>
                                <span>{{ action.label }}</span>
                              </button>
                            }
                          </mat-menu>
                        }
                      </div>
                    </div>
                  }
                </div>
              }
            }
          }
        </mat-card-content>
      </mat-card>
    </mat-tab>
  </mat-tab-group>
</div>
